-- Khởi tạo Database
CREATE DATABASE LMS;
SELECT SUSER_NAME();
SELECT @@SERVERNAME
SELECT @@VERSION
SELECT SERVERPROPERTY('productversion'), SERVERPROPERTY ('edition')

USE Chater1;
DROP DATABASE LMS;
-- Khởi tạo các bảng
USE LMS;
-- Bảng Tài khoản
CREATE TABLE TaiKhoan (
    ID VARCHAR(40) PRIMARY KEY,
    USERNAME VARCHAR(50) NOT NULL UNIQUE,
    PASSWORD VARCHAR(255) NOT NULL,
    ROLE TINYINT NOT NULL CHECK (ROLE IN (0, 1, 2)) -- 0: Admin, 1: SV, 2: GV
);

-- Bảng Sinh viên
CREATE TABLE SinhVien (
    MSSV CHAR(20) PRIMARY KEY,
    TENSV NVARCHAR(100) NOT NULL,
    NAMSINH DATE NOT NULL,
    KHOA INT NOT NULL,
    MANGANH CHAR(10),
    TONGTINCHI INT DEFAULT 0,
    GPA FLOAT DEFAULT 0.0    
);
-- Bảng Giảng viên
CREATE TABLE GiangVien (
    MSGV CHAR(20) PRIMARY KEY,
    TENGV NVARCHAR(100) NOT NULL,
    NAMSINH DATE NOT NULL,
    TRINHDO NVARCHAR(50) NOT NULL
);

-- Bảng Lớp học
CREATE TABLE LopHoc (
    MALH CHAR(10) PRIMARY KEY,
    MAMH CHAR(10) NOT NULL,
    MAPG CHAR(10),
    MSGV CHAR(20),
    CA TINYINT NOT NULL CHECK (CA BETWEEN 1 AND 5), -- Ca học từ 1 đến 5
    NGAYHOC TINYINT NOT NULL CHECK (NGAYHOC BETWEEN 1 AND 7), -- Thứ 2 -> Chủ nhật (1->7)
    NGAYSTART SMALLDATETIME NOT NULL,
    NGAYEND SMALLDATETIME NOT NULL,
    TRANGTHAI TINYINT NOT NULL CHECK (TRANGTHAI IN (0, 1)) -- 0: mở, 1: khóa
);


-- Bảng Môn học
CREATE TABLE MonHoc (
    MAMH CHAR(10) PRIMARY KEY,
    MANGANH CHAR(10),
    TENMH NVARCHAR(100) NOT NULL,
    SOBUOI INT NOT NULL,
    TINCHI INT NOT NULL    
);


-- Bảng Chuyên ngành
CREATE TABLE ChuyenNganh (
    MANGANH CHAR(10) PRIMARY KEY,
    TENNGANH NVARCHAR(100) NOT NULL
);

-- Bảng Điểm số
CREATE TABLE DiemSo (
    MSSV CHAR(20),
    MAMH CHAR(10),
    D_GKY FLOAT,
    D_CKY FLOAT,
    TONG FLOAT,
    TRANGTHAI TINYINT NOT NULL CHECK (TRANGTHAI IN (0, 1)), -- 0: rớt, 1: đậu
    PRIMARY KEY (MSSV, MAMH)
);


-- Bảng Phòng học
CREATE TABLE PhongHoc (
    MAPG CHAR(10) PRIMARY KEY,
    SIZE INT NOT NULL
);

-- Bảng DSLOP: danh sách lớp
CREATE TABLE DSLOP (
    MALH CHAR(10),
    MSSV CHAR(20),
    PRIMARY KEY (MALH, MSSV)
);



-- Bảng LOPGV: những lớp giảng viên đang dạy
CREATE TABLE LOPGV (
    MSGV CHAR(20),
    MALH CHAR(10),
    PRIMARY KEY (MSGV, MALH)
);

-- Bảng GV_MH: những môn mà giảng viên có thể dạy
CREATE TABLE GV_MH (
    MSGV CHAR(20),
    MAMH CHAR(10),
    PRIMARY KEY (MSGV, MAMH)
);

-- Bảng TK_SV: Liên kết tài khoản với sinh viên
CREATE TABLE TK_SV (
    ID VARCHAR(40),
    MSSV CHAR(20),
    PRIMARY KEY (ID, MSSV)
);


-- Bảng TK_GV: Liên kết tài khoản với giảng viên
CREATE TABLE TK_GV (
    ID VARCHAR(40),
    MSGV CHAR(20),
    PRIMARY KEY (ID, MSGV)
);

-- Thiết lập các khóa ngoại
ALTER TABLE SinhVien ADD FOREIGN KEY (MANGANH) REFERENCES ChuyenNganh(MANGANH) ON DELETE SET NULL;
ALTER TABLE LopHoc ADD FOREIGN KEY (MAMH) REFERENCES MonHoc(MAMH) ON DELETE CASCADE;
ALTER TABLE LopHoc ADD FOREIGN KEY (MAPG) REFERENCES PhongHoc(MAPG) ON DELETE CASCADE;
ALTER TABLE LopHoc ADD FOREIGN KEY (MSGV) REFERENCES GiangVien(MSGV) ON DELETE SET NULL;
ALTER TABLE MonHoc ADD FOREIGN KEY (MANGANH) REFERENCES ChuyenNganh(MANGANH) ON DELETE CASCADE;
ALTER TABLE DiemSo ADD FOREIGN KEY (MSSV) REFERENCES SinhVien(MSSV) ON DELETE CASCADE;
ALTER TABLE DiemSo ADD FOREIGN KEY (MAMH) REFERENCES MonHoc(MAMH) ON DELETE CASCADE;
ALTER TABLE DSLOP ADD FOREIGN KEY (MALH) REFERENCES LopHoc(MALH) ON DELETE CASCADE;
ALTER TABLE DSLOP ADD FOREIGN KEY (MSSV) REFERENCES SinhVien(MSSV) ON DELETE CASCADE;
ALTER TABLE LOPGV ADD FOREIGN KEY (MSGV) REFERENCES GiangVien(MSGV) ON DELETE CASCADE;
ALTER TABLE LOPGV ADD FOREIGN KEY (MALH) REFERENCES LopHoc(MALH) ON DELETE CASCADE;
ALTER TABLE GV_MH ADD FOREIGN KEY (MAMH) REFERENCES MonHoc(MAMH) ON DELETE CASCADE;
ALTER TABLE GV_MH ADD FOREIGN KEY (MSGV) REFERENCES GiangVien(MSGV) ON DELETE CASCADE;
ALTER TABLE TK_SV ADD FOREIGN KEY (ID) REFERENCES TaiKhoan(ID) ON DELETE CASCADE;
ALTER TABLE TK_SV ADD FOREIGN KEY (MSSV) REFERENCES SinhVien(MSSV) ON DELETE CASCADE;
ALTER TABLE TK_GV ADD FOREIGN KEY (ID) REFERENCES TaiKhoan(ID) ON DELETE CASCADE;
ALTER TABLE TK_GV ADD FOREIGN KEY (MSGV) REFERENCES GiangVien(MSGV) ON DELETE CASCADE;


	DELETE FROM TaiKhoan WHERE ID = '051205008812';
	DELETE FROM TaiKhoan WHERE ID = 'admin';
use [LMS];
 
SELECT * FROM TaiKhoan;
SELECT * FROM SinhVien;
SELECT * FROM GiangVien;
SELECT * FROM LopHoc;
SELECT * FROM MonHoc;
SELECT * FROM ChuyenNganh;
SELECT * FROM DiemSo;
SELECT * FROM PhongHoc;
SELECT * FROM DSLOP;
SELECT * FROM LOPGV;
SELECT * FROM GV_MH;
SELECT * FROM TK_SV;
SELECT * FROM TK_GV;

-- KHỞI TẠO DỮ LIỆU CHUYÊN NGÀNH
INSERT INTO ChuyenNganh (MANGANH, TENNGANH) VALUES ('MN0001', N'CÔNG NGHỆ THÔNG TIN');
INSERT INTO ChuyenNganh (MANGANH, TENNGANH) VALUES ('MN0002', N'HỆ THỐNG THÔNG TIN');
INSERT INTO ChuyenNganh (MANGANH, TENNGANH) VALUES ('MN0003', N'KHOA HỌC DỮ LIỆU');
INSERT INTO ChuyenNganh (MANGANH, TENNGANH) VALUES ('MN0004', N'TRÍ TUỆ NHÂN TẠO');
INSERT INTO ChuyenNganh (MANGANH, TENNGANH) VALUES ('MN0005', N'LOGISTICS');

UPDATE ChuyenNganh  SET TENNGANH = N'CONG NGHE THONG TIN'WHERE MANGANH = 'MN0001'
UPDATE ChuyenNganh  SET TENNGANH = N'HE THONG THONG TIN' WHERE MANGANH = 'MN0002'
UPDATE ChuyenNganh  SET TENNGANH = N'KHOA HOC DU LIEU'	  WHERE MANGANH = 'MN0003'
UPDATE ChuyenNganh  SET TENNGANH = N'TRI TRUE NHAN TAO'	  WHERE MANGANH = 'MN0004'
UPDATE ChuyenNganh  SET TENNGANH = N'LOGISTICS'		  WHERE MANGANH = 'MN0005'


-- KHỞI TẠO DỮ LIỆU MÔN HỌC
INSERT INTO MonHoc (MAMH, MANGANH, TENMH, SOBUOI, TINCHI) VALUES ('MH0001', 'MN0001', N'Introduction to Programming'	, 10, 3);
INSERT INTO MonHoc (MAMH, MANGANH, TENMH, SOBUOI, TINCHI) VALUES ('MH0002', 'MN0001', N'Data Structures and Algorithms', 10, 4);
INSERT INTO MonHoc (MAMH, MANGANH, TENMH, SOBUOI, TINCHI) VALUES ('MH0003', 'MN0001', N'Computer Networks'			, 10, 3);
INSERT INTO MonHoc (MAMH, MANGANH, TENMH, SOBUOI, TINCHI) VALUES ('MH0004', 'MN0001', N'Operating Systems'			, 10, 3);
INSERT INTO MonHoc (MAMH, MANGANH, TENMH, SOBUOI, TINCHI) VALUES ('MH0005', 'MN0001', N'Database Systems'			, 10, 3);

INSERT INTO MonHoc (MAMH, MANGANH, TENMH, SOBUOI, TINCHI) VALUES ('MH0006', 'MN0002', N'IT Project Management'			, 10, 3);
INSERT INTO MonHoc (MAMH, MANGANH, TENMH, SOBUOI, TINCHI) VALUES ('MH0007', 'MN0002', N'Enterprise Information Systems', 10, 3);
INSERT INTO MonHoc (MAMH, MANGANH, TENMH, SOBUOI, TINCHI) VALUES ('MH0008', 'MN0002', N'System Analysis and Design'	, 10, 3);
INSERT INTO MonHoc (MAMH, MANGANH, TENMH, SOBUOI, TINCHI) VALUES ('MH0009', 'MN0002', N'Software Engineering'			, 10, 3);
INSERT INTO MonHoc (MAMH, MANGANH, TENMH, SOBUOI, TINCHI) VALUES ('MH0010', 'MN0002', N'Data Processing Techniques'	, 10, 3);

INSERT INTO MonHoc (MAMH, MANGANH, TENMH, SOBUOI, TINCHI) VALUES ('MH0011', 'MN0003', N'Data Analytics'				, 10, 3);
INSERT INTO MonHoc (MAMH, MANGANH, TENMH, SOBUOI, TINCHI) VALUES ('MH0012', 'MN0003', N'Machine Learning'				, 10, 3);
INSERT INTO MonHoc (MAMH, MANGANH, TENMH, SOBUOI, TINCHI) VALUES ('MH0013', 'MN0003', N'Natural Language Processing'	, 10, 3);
INSERT INTO MonHoc (MAMH, MANGANH, TENMH, SOBUOI, TINCHI) VALUES ('MH0014', 'MN0003', N'Applied Statistics'			, 10, 3);
INSERT INTO MonHoc (MAMH, MANGANH, TENMH, SOBUOI, TINCHI) VALUES ('MH0015', 'MN0003', N'Big Data'						, 10, 3);

INSERT INTO MonHoc (MAMH, MANGANH, TENMH, SOBUOI, TINCHI) VALUES ('MH0016', 'MN0004', N'Neural Networks and Deep Learning'	, 10, 3);
INSERT INTO MonHoc (MAMH, MANGANH, TENMH, SOBUOI, TINCHI) VALUES ('MH0017', 'MN0004', N'Computer Vision'					, 10, 3);
INSERT INTO MonHoc (MAMH, MANGANH, TENMH, SOBUOI, TINCHI) VALUES ('MH0018', 'MN0004', N'Natural Language Processing'		, 10, 3);
INSERT INTO MonHoc (MAMH, MANGANH, TENMH, SOBUOI, TINCHI) VALUES ('MH0019', 'MN0004', N'AI Programming'					, 10, 3);
INSERT INTO MonHoc (MAMH, MANGANH, TENMH, SOBUOI, TINCHI) VALUES ('MH0020', 'MN0004', N'Robotics'							, 10, 3);

INSERT INTO MonHoc (MAMH, MANGANH, TENMH, SOBUOI, TINCHI) VALUES ('MH0021', 'MN0005', N'Supply Chain Management'					, 10, 3);
INSERT INTO MonHoc (MAMH, MANGANH, TENMH, SOBUOI, TINCHI) VALUES ('MH0022', 'MN0005', N'Warehouse and Transportation Management'	, 10, 3);
INSERT INTO MonHoc (MAMH, MANGANH, TENMH, SOBUOI, TINCHI) VALUES ('MH0023', 'MN0005', N'Enterprise Resource Planning - ERP'		, 10, 3);
INSERT INTO MonHoc (MAMH, MANGANH, TENMH, SOBUOI, TINCHI) VALUES ('MH0024', 'MN0005', N'Logistics Operations Optimization'			, 10, 3);
INSERT INTO MonHoc (MAMH, MANGANH, TENMH, SOBUOI, TINCHI) VALUES ('MH0025', 'MN0005', N'Risk Management in Logistics'				, 10, 3);

-- KHỞI TẠO DỮ LIỆU PHÒNG HỌC
INSERT INTO PhongHoc(MAPG, SIZE) VALUES ('P01', 100);
INSERT INTO PhongHoc(MAPG, SIZE) VALUES ('P02', 50);
INSERT INTO PhongHoc(MAPG, SIZE) VALUES ('P03', 60);
INSERT INTO PhongHoc(MAPG, SIZE) VALUES ('P04', 60);
INSERT INTO PhongHoc(MAPG, SIZE) VALUES ('P05', 70);


